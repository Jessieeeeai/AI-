# Feature: çœŸå®å£°éŸ³å…‹éš†é¢„è§ˆ

## ç”¨æˆ·éœ€æ±‚

**ç”¨æˆ·åé¦ˆï¼š** "è¿™ä¸ªè¯•å¬æ˜¯å¬çš„æˆ‘ä¸Šä¼ çš„éŸ³é¢‘ï¼Œå¹¶ä¸æ˜¯æˆ‘çš„æ–‡å­—ç”¨æˆ‘ä¸Šä¼ çš„è¯­éŸ³ç”Ÿæˆçš„å•Š"

**æ­£ç¡®çš„éœ€æ±‚ï¼š**
1. ä¸Šä¼ å£°éŸ³æ ·æœ¬ï¼ˆå£°éŸ³å…‹éš†ï¼‰
2. è¾“å…¥æˆ–ä½¿ç”¨æµ‹è¯•æ–‡æœ¬
3. ç‚¹å‡»"è¯•å¬" â†’ **ç”¨å…‹éš†çš„å£°éŸ³æœ—è¯»è¿™æ®µæ–‡æœ¬**

## å®ç°æ–¹æ¡ˆ

### æ¶æ„è®¾è®¡

```
å‰ç«¯ Step2VoiceSettings
    â†“
è°ƒç”¨ previewService.generateTTS()
    â†“
POST /api/preview/tts
    â†“
åç«¯ IndexTTS2 æœåŠ¡
    â†“
è¿”å›ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ (WAV)
    â†“
å‰ç«¯æ’­æ”¾éŸ³é¢‘
```

### æ ¸å¿ƒåŠŸèƒ½

#### 1. åç«¯é¢„è§ˆAPI

**æ–‡ä»¶ï¼š** `server/routes/preview.js`

```javascript
router.post('/tts', async (req, res) => {
  const { text, voiceId, voiceSettings } = req.body;
  
  // å‡†å¤‡æƒ…æ„Ÿå‘é‡ï¼ˆ8ç»´ï¼‰
  const emoVector = [
    voiceSettings?.happiness || 0.7,
    voiceSettings?.anger || 0.0,
    voiceSettings?.sadness || 0.1,
    0.0, // afraid
    0.0, // disgusted
    0.0, // melancholic
    voiceSettings?.surprise || 0.3,
    1.0 - (voiceSettings?.happiness || 0.7) // calm
  ];
  
  // è°ƒç”¨IndexTTS2
  const response = await axios.post(
    `${indextts2Url}/api/v1/tts`,
    { text, voiceId, emoVector, emoAlpha: 0.8 },
    { responseType: 'arraybuffer' }
  );
  
  // è¿”å›éŸ³é¢‘æ•°æ®
  res.set('Content-Type', 'audio/wav');
  res.send(response.data);
});
```

#### 2. å‰ç«¯é¢„è§ˆæœåŠ¡

**æ–‡ä»¶ï¼š** `client/src/services/api.js`

```javascript
export const previewService = {
  generateTTS: (text, voiceId, voiceSettings) =>
    api.post('/preview/tts', 
      { text, voiceId, voiceSettings }, 
      { responseType: 'blob' }
    ),
};
```

#### 3. å‰ç«¯ç»„ä»¶é€»è¾‘

**æ–‡ä»¶ï¼š** `client/src/components/create/Step2VoiceSettings.jsx`

```javascript
const handlePreview = async () => {
  if (useCustomVoice && uploadedVoice) {
    setIsPreviewing(true);
    
    try {
      // 1. ç¡®å®šé¢„è§ˆæ–‡æœ¬
      const previewText = data.text && data.text.trim().length > 0
        ? data.text.substring(0, 100) // ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„æ–‡æœ¬
        : 'ä½ å¥½ï¼Œè¿™æ˜¯ä½¿ç”¨æ‚¨çš„å£°éŸ³ç”Ÿæˆçš„é¢„è§ˆæ•ˆæœã€‚æ¬¢è¿ä½¿ç”¨VideoAI Proï¼';
      
      // 2. è°ƒç”¨TTS API
      const audioBlob = await previewService.generateTTS(
        previewText,
        uploadedVoice.voiceId,
        settings // åŒ…å«æƒ…æ„Ÿå‚æ•°
      );
      
      // 3. åˆ›å»ºéŸ³é¢‘URL
      const audioUrl = URL.createObjectURL(audioBlob);
      
      // 4. æ’­æ”¾
      audioRef.current.src = audioUrl;
      await audioRef.current.play();
      
    } catch (error) {
      alert('é¢„è§ˆå¤±è´¥ï¼š' + error.message);
    } finally {
      setIsPreviewing(false);
    }
  }
};
```

---

## åŠŸèƒ½ç‰¹æ€§

### âœ… çœŸå®çš„å£°éŸ³å…‹éš†

- ä½¿ç”¨ä¸Šä¼ çš„å£°éŸ³æ ·æœ¬è¿›è¡Œå…‹éš†
- é€šè¿‡IndexTTS2ç”ŸæˆéŸ³é¢‘
- åº”ç”¨æƒ…æ„Ÿå‚æ•°ï¼ˆ8ç»´æƒ…æ„Ÿå‘é‡ï¼‰
- éŸ³è´¨æ¥è¿‘çœŸå®ç”Ÿæˆæ•ˆæœ

### âœ… æ™ºèƒ½æ–‡æœ¬é€‰æ‹©

**ä¼˜å…ˆçº§ï¼š**
1. å¦‚æœç”¨æˆ·å·²åœ¨"è¾“å…¥æ–‡å­—"æ­¥éª¤è¾“å…¥æ–‡æœ¬ â†’ ä½¿ç”¨å‰100å­—
2. å¦åˆ™ä½¿ç”¨é»˜è®¤æµ‹è¯•æ–‡æœ¬

**æç¤ºUIï¼š**
```
âœ¨ è¯•å¬å°†ä½¿ç”¨æ‚¨çš„å£°éŸ³å…‹éš†æœ—è¯»æµ‹è¯•æ–‡æœ¬
ï¼ˆä½¿ç”¨æ‚¨è¾“å…¥çš„æ–‡æœ¬å‰100å­—ï¼‰
```

æˆ–

```
âœ¨ è¯•å¬å°†ä½¿ç”¨æ‚¨çš„å£°éŸ³å…‹éš†æœ—è¯»æµ‹è¯•æ–‡æœ¬
ï¼ˆä½¿ç”¨é»˜è®¤æµ‹è¯•æ–‡æœ¬ï¼‰
```

### âœ… å®Œæ•´å‚æ•°åº”ç”¨

**æƒ…æ„Ÿå‚æ•°ï¼ˆæ˜ å°„åˆ°8ç»´ï¼‰ï¼š**
- happiness â†’ emo[0]
- anger â†’ emo[1]
- sadness â†’ emo[2]
- surprise â†’ emo[6]
- calm â†’ emo[7] (è‡ªåŠ¨è®¡ç®—)

**éŸ³é¢‘å‚æ•°ï¼š**
- volumeï¼šåº”ç”¨åˆ°æ’­æ”¾å™¨
- pitch/speedï¼šTTSæ¨¡å‹å¤„ç†ï¼ˆIndexTTS2æ”¯æŒï¼‰

---

## ç”¨æˆ·ä½“éªŒ

### Beforeï¼ˆä¹‹å‰ï¼‰
- âŒ æ’­æ”¾åŸå§‹ä¸Šä¼ çš„éŸ³é¢‘
- âŒ æ— æ³•é¢„è§ˆå£°éŸ³å…‹éš†æ•ˆæœ
- âŒ æ— æ³•é¢„è§ˆæƒ…æ„Ÿå‚æ•°
- âŒ ç”¨æˆ·å›°æƒ‘ï¼š"ä¸æ˜¯æˆ‘çš„æ–‡å­—å•Š"

### Afterï¼ˆç°åœ¨ï¼‰
- âœ… ä½¿ç”¨å£°éŸ³å…‹éš†ç”ŸæˆéŸ³é¢‘
- âœ… å¯ä»¥å¬åˆ°å…‹éš†å£°éŸ³æœ—è¯»æ–‡æœ¬
- âœ… åº”ç”¨æ‰€æœ‰æƒ…æ„Ÿå‚æ•°
- âœ… çœŸå®é¢„è§ˆæœ€ç»ˆæ•ˆæœ
- âœ… æ¸…æ™°çš„æç¤ºä¿¡æ¯

---

## ä½¿ç”¨æµç¨‹

### å®Œæ•´æµ‹è¯•æµç¨‹

1. **ç™»å½•VIPè´¦å·**
   - Email: vip@videoai.com
   - Password: vip123456

2. **è¿›å…¥åˆ›å»ºè§†é¢‘**
   - ç‚¹å‡»"åˆ›å»ºè§†é¢‘"æŒ‰é’®

3. **ç¬¬1æ­¥ï¼šè¾“å…¥æ–‡å­—**
   ```
   è¾“å…¥ï¼šå¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°VideoAI Proï¼
         è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨äººå·¥æ™ºèƒ½æŠ€æœ¯ç”Ÿæˆæ•°å­—äººè§†é¢‘çš„å¹³å°ã€‚
   ç‚¹å‡»ï¼šä¸‹ä¸€æ­¥
   ```

4. **ç¬¬2æ­¥ï¼šè°ƒèŠ‚å£°éŸ³**
   - é€‰æ‹©ï¼š"ä¸Šä¼ æˆ‘çš„å£°éŸ³"
   - ä¸Šä¼ ï¼šæ‚¨çš„éŸ³é¢‘æ–‡ä»¶ï¼ˆ15-60ç§’ï¼‰
   - ç­‰å¾…ä¸Šä¼ æˆåŠŸ

5. **è°ƒæ•´å‚æ•°**
   ```
   å¿«ä¹åº¦ï¼š80%
   æ‚²ä¼¤åº¦ï¼š10%
   æ„¤æ€’åº¦ï¼š0%
   æƒŠè®¶åº¦ï¼š30%
   ```

6. **ç‚¹å‡»"ğŸ§ è¯•å¬"**
   - ç³»ç»Ÿä¼šè°ƒç”¨TTS API
   - ç”Ÿæˆæ—¶é—´ï¼š5-10ç§’
   - æ’­æ”¾ï¼šç”¨æ‚¨çš„å£°éŸ³æœ—è¯» "å¤§å®¶å¥½ï¼Œæ¬¢è¿æ¥åˆ°..."

7. **å¬æ•ˆæœ**
   - å£°éŸ³ï¼šæ‚¨çš„å£°éŸ³ï¼ˆå…‹éš†ï¼‰
   - å†…å®¹ï¼šæ‚¨è¾“å…¥çš„æ–‡æœ¬ï¼ˆå‰100å­—ï¼‰
   - æƒ…æ„Ÿï¼šåº”ç”¨æ‚¨è®¾ç½®çš„å‚æ•°

---

## æŠ€æœ¯ç»†èŠ‚

### Mockæ¨¡å¼ vs çœŸå®æ¨¡å¼

#### Mockæ¨¡å¼ï¼ˆå½“å‰æ²™ç®±ç¯å¢ƒï¼‰

**IndexTTS2æœåŠ¡ï¼š** `http://localhost:5000` (Mock)

**ç‰¹ç‚¹ï¼š**
- âœ… ç”Ÿæˆé€Ÿåº¦å¿«ï¼ˆ3-5ç§’ï¼‰
- âœ… ä¸éœ€è¦GPU
- âš ï¸ ç”Ÿæˆçš„æ˜¯ç®€å•æµ‹è¯•éŸ³é¢‘
- âš ï¸ ä¸æ˜¯çœŸå®çš„å£°éŸ³å…‹éš†

**MockæœåŠ¡è¡Œä¸ºï¼š**
```python
# server/services/mock_indextts2_server.py
@app.route('/api/v1/tts', methods=['POST'])
def tts():
    # ç”Ÿæˆç®€å•çš„æ­£å¼¦æ³¢éŸ³é¢‘
    audio_data = generate_sine_wave(duration=3.0)
    return send_audio(audio_data)
```

#### çœŸå®æ¨¡å¼ï¼ˆGPUæœåŠ¡å™¨ï¼‰

**IndexTTS2æœåŠ¡ï¼š** çœŸå®çš„TTSæ¨¡å‹

**ç‰¹ç‚¹ï¼š**
- âœ… çœŸå®çš„å£°éŸ³å…‹éš†
- âœ… é«˜è´¨é‡éŸ³é¢‘
- âœ… å®Œæ•´çš„æƒ…æ„Ÿæ§åˆ¶
- âš ï¸ éœ€è¦GPUï¼ˆ24GB+ VRAMï¼‰
- âš ï¸ ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼ˆ10-30ç§’ï¼‰

### APIå‚æ•°è¯´æ˜

**è¯·æ±‚ï¼š**
```json
{
  "text": "é¢„è§ˆæ–‡æœ¬å†…å®¹",
  "voiceId": "ä¸Šä¼ çš„å£°éŸ³ID",
  "voiceSettings": {
    "happiness": 0.8,
    "anger": 0.0,
    "sadness": 0.1,
    "surprise": 0.3,
    "pitch": 1.0,
    "speed": 1.0,
    "volume": 1.0
  }
}
```

**å“åº”ï¼š**
```
Content-Type: audio/wav
Content-Disposition: inline; filename="preview.wav"
[Binary Audio Data]
```

### é”™è¯¯å¤„ç†

**å¯èƒ½çš„é”™è¯¯ï¼š**

1. **TTSæœåŠ¡ä¸å¯ç”¨**
   ```json
   {
     "error": "service_unavailable",
     "message": "TTSæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ä½¿ç”¨Mockæ¨¡å¼"
   }
   ```

2. **æ–‡æœ¬å¤ªé•¿**
   ```json
   {
     "error": "text_too_long",
     "message": "é¢„è§ˆæ–‡æœ¬ä¸èƒ½è¶…è¿‡100å­—"
   }
   ```

3. **å£°éŸ³IDæ— æ•ˆ**
   ```json
   {
     "error": "invalid_voice",
     "message": "å£°éŸ³æ–‡ä»¶ä¸å­˜åœ¨æˆ–æœªå¤„ç†å®Œæˆ"
   }
   ```

---

## é™åˆ¶è¯´æ˜

### å½“å‰é™åˆ¶ï¼ˆMockæ¨¡å¼ï¼‰

1. **ä¸æ˜¯çœŸå®å£°éŸ³å…‹éš†**
   - MockæœåŠ¡è¿”å›ç®€å•çš„æµ‹è¯•éŸ³é¢‘
   - ä¸ä¼šçœŸçš„å…‹éš†æ‚¨çš„å£°éŸ³
   - ç”¨äºæµ‹è¯•æµç¨‹å’ŒUI

2. **ä¸åº”ç”¨æƒ…æ„Ÿå‚æ•°**
   - MockæœåŠ¡å¿½ç•¥æƒ…æ„Ÿå‚æ•°
   - å§‹ç»ˆè¿”å›ç›¸åŒçš„æµ‹è¯•éŸ³é¢‘

3. **éŸ³è´¨ç®€å•**
   - åªæ˜¯æ­£å¼¦æ³¢æˆ–ç™½å™ªå£°
   - ä¸åŒ…å«è¯­éŸ³å†…å®¹

### è§£å†³æ–¹æ¡ˆ

**éƒ¨ç½²çœŸå®IndexTTS2æœåŠ¡ï¼š**

1. **å‡†å¤‡GPUæœåŠ¡å™¨**
   - NVIDIA GPU (24GB+ VRAM)
   - CUDA 11.8+
   - Python 3.9+

2. **è¿è¡Œéƒ¨ç½²è„šæœ¬**
   ```bash
   cd /home/user/webapp
   sudo bash deploy_gpu_production.sh
   ```

3. **æ›´æ–°ç¯å¢ƒå˜é‡**
   ```bash
   # .env.production
   INDEXTTS2_API_URL=http://localhost:5000  # æŒ‡å‘çœŸå®æœåŠ¡
   ```

4. **é‡å¯æœåŠ¡**
   ```bash
   pm2 restart videoai-backend
   ```

---

## å¯¹æ¯”è¡¨

| åŠŸèƒ½ | æ’­æ”¾åŸéŸ³é¢‘ | ç³»ç»ŸTTS | Mock TTSé¢„è§ˆ | çœŸå®TTSé¢„è§ˆ | çœŸå®è§†é¢‘ç”Ÿæˆ |
|------|-----------|---------|-------------|------------|-------------|
| **å£°éŸ³** | åŸå§‹å½•éŸ³ | ç³»ç»Ÿé»˜è®¤ | æµ‹è¯•éŸ³é¢‘ | âœ… å…‹éš†å£°éŸ³ | âœ… å…‹éš†å£°éŸ³ |
| **æ–‡æœ¬** | å›ºå®š | å›ºå®š | å›ºå®š | âœ… è‡ªå®šä¹‰ | âœ… è‡ªå®šä¹‰ |
| **æƒ…æ„Ÿ** | âŒ | âŒ | âŒ | âœ… 8ç»´æ§åˆ¶ | âœ… 8ç»´æ§åˆ¶ |
| **éŸ³è°ƒ** | âŒ | âœ… | âŒ | âœ… å¯è°ƒæ•´ | âœ… å¯è°ƒæ•´ |
| **è¯­é€Ÿ** | âŒ | âœ… | âŒ | âœ… å¯è°ƒæ•´ | âœ… å¯è°ƒæ•´ |
| **éŸ³é‡** | âœ… | âœ… | âœ… | âœ… å¯è°ƒæ•´ | âœ… å¯è°ƒæ•´ |
| **é€Ÿåº¦** | å³æ—¶ | å³æ—¶ | 3-5ç§’ | 10-30ç§’ | åˆ†é’Ÿçº§ |
| **GPU** | ä¸éœ€è¦ | ä¸éœ€è¦ | ä¸éœ€è¦ | éœ€è¦ | éœ€è¦ |

---

## æµ‹è¯•éªŒè¯

### 1. Mockæ¨¡å¼æµ‹è¯•

```bash
# å¯åŠ¨MockæœåŠ¡ï¼ˆåº”è¯¥å·²ç»åœ¨è¿è¡Œï¼‰
ps aux | grep mock_indextts2

# æµ‹è¯•Mock API
curl -X POST http://localhost:5000/api/v1/tts \
  -H "Content-Type: application/json" \
  -d '{"text":"æµ‹è¯•","voiceId":"test","emoVector":[0.7,0,0.1,0,0,0,0.3,0.3]}'

# åº”è¯¥è¿”å›éŸ³é¢‘æ•°æ®
```

### 2. å‰ç«¯åŠŸèƒ½æµ‹è¯•

```
1. åˆ·æ–°æµè§ˆå™¨
2. ç™»å½•VIPè´¦å·
3. åˆ›å»ºè§†é¢‘ â†’ è¾“å…¥æ–‡å­—ï¼ˆè‡³å°‘20å­—ï¼‰
4. ä¸‹ä¸€æ­¥ â†’ è°ƒèŠ‚å£°éŸ³
5. ä¸Šä¼ å£°éŸ³æ–‡ä»¶
6. ç‚¹å‡»"è¯•å¬"
7. ç­‰å¾…5-10ç§’
8. åº”è¯¥å¬åˆ°ç”Ÿæˆçš„éŸ³é¢‘ï¼ˆMockæ¨¡å¼ä¸‹æ˜¯æµ‹è¯•éŸ³ï¼‰
```

### 3. å¼€å‘è€…å·¥å…·æ£€æŸ¥

```
F12 â†’ Networkæ ‡ç­¾
ç‚¹å‡»"è¯•å¬"
æŸ¥æ‰¾ï¼š/api/preview/tts
çŠ¶æ€ï¼š200 OK
ç±»å‹ï¼šaudio/wav
å¤§å°ï¼š>0 KB
```

### 4. æ§åˆ¶å°æ—¥å¿—

```
ğŸ¤ ç”Ÿæˆå£°éŸ³å…‹éš†é¢„è§ˆ: {...}
[åç«¯] ğŸ“¢ TTSé¢„è§ˆè¯·æ±‚: {...}
```

---

## æ–‡ä»¶ä¿®æ”¹

### æ–°å¢æ–‡ä»¶

1. **`server/routes/preview.js`**
   - TTSé¢„è§ˆAPIè·¯ç”±

### ä¿®æ”¹æ–‡ä»¶

1. **`server/index.js`**
   - å¯¼å…¥previewRoutes
   - æ³¨å†Œ/api/previewè·¯ç”±

2. **`client/src/services/api.js`**
   - æ·»åŠ previewService

3. **`client/src/components/create/Step2VoiceSettings.jsx`**
   - å¯¼å…¥previewService
   - ä¿®æ”¹handlePreview()é€»è¾‘
   - æ›´æ–°UIæç¤ºä¿¡æ¯

---

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ
- âœ… Nodemonè‡ªåŠ¨é‡å¯åç«¯
- âœ… Viteçƒ­é‡è½½å‰ç«¯
- âœ… MockæœåŠ¡å·²è¿è¡Œ

### ç”Ÿäº§ç¯å¢ƒ

**ç¡®ä¿æœåŠ¡è¿è¡Œï¼š**
```bash
pm2 status

# åº”è¯¥çœ‹åˆ°ï¼š
# - videoai-backend (online)
# - mock-indextts2 (online) æˆ–çœŸå®TTSæœåŠ¡
```

**æµ‹è¯•APIï¼š**
```bash
curl -X POST http://localhost:3001/api/preview/tts \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "æµ‹è¯•æ–‡æœ¬",
    "voiceId": "test",
    "voiceSettings": {"happiness": 0.8}
  }' \
  --output preview.wav

# åº”è¯¥ç”Ÿæˆpreview.wavæ–‡ä»¶
```

---

**çŠ¶æ€ï¼š** âœ… å·²å®ç°  
**æµ‹è¯•ï¼š** Mockæ¨¡å¼å¯ç”¨ï¼ŒGPUæ¨¡å¼éœ€éƒ¨ç½²  
**ä¼˜å…ˆçº§ï¼š** Highï¼ˆæ ¸å¿ƒç”¨æˆ·éœ€æ±‚ï¼‰
