# 📊 部署流程图 - VideoAI Pro on RunPod

可视化的部署流程和系统架构。

---

## 🎯 整体部署流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      RunPod 部署流程                              │
└─────────────────────────────────────────────────────────────────┘

第1步: 创建GPU实例 (2分钟)
┌──────────────┐
│   RunPod     │  选择GPU → 配置资源 → 启动实例
│   Console    │  
└──────┬───────┘
       │
       ↓
第2步: 部署 VideoAI Pro (5分钟)
┌──────────────┐
│   SSH连接    │  git clone → 运行脚本 → 自动部署
│   服务器     │  
└──────┬───────┘
       │
       ↓
第3步: 部署AI服务 (30-60分钟)
┌──────────────┐
│ IndexTTS2 +  │  安装依赖 → 下载模型 → 启动服务
│   ComfyUI    │  
└──────┬───────┘
       │
       ↓
✅ 完成！访问网站
┌──────────────┐
│   浏览器     │  http://your-ip → 注册 → 创建视频
└──────────────┘
```

---

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         RunPod GPU 服务器                         │
│                      (RTX 3090 24GB VRAM)                        │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        │                       │                       │
        ↓                       ↓                       ↓
┌──────────────┐        ┌──────────────┐       ┌──────────────┐
│    Nginx     │        │    Redis     │       │   SQLite     │
│  (Port 80)   │        │ (Port 6379)  │       │  (Database)  │
└──────┬───────┘        └──────┬───────┘       └──────┬───────┘
       │                       │                       │
       │                       │                       │
       └───────────────────────┼───────────────────────┘
                               │
                               ↓
                    ┌──────────────────┐
                    │   Express.js     │
                    │   Backend API    │
                    │   (Port 3001)    │
                    └──────────┬───────┘
                               │
                ┌──────────────┼──────────────┐
                │              │              │
                ↓              ↓              ↓
        ┌──────────┐   ┌──────────┐   ┌──────────┐
        │   Bull   │   │ IndexTTS2│   │ ComfyUI  │
        │  Queue   │   │(Port 9880│   │(Port 8188│
        │  Worker  │   └──────────┘   └──────────┘
        └──────────┘          │              │
                              │              │
                              ↓              ↓
                    ┌──────────────┐ ┌──────────────┐
                    │  TTS Model   │ │MuseTalk Model│
                    │  (GPU加速)   │ │  (GPU加速)   │
                    └──────────────┘ └──────────────┘
```

---

## 🔄 视频生成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                       用户创建视频流程                            │
└─────────────────────────────────────────────────────────────────┘

Step 1: 用户输入文本
┌──────────────┐
│   前端页面   │  输入: "大家好，我是AI数字人..."
└──────┬───────┘
       │
       ↓
Step 2: AI文本优化
┌──────────────┐
│  GPT-4 API   │  优化: 添加情感、转换数字、简化标点
└──────┬───────┘
       │
       ↓
Step 3: 创建任务
┌──────────────┐
│  Express API │  创建任务 → 存入数据库 → 加入队列
└──────┬───────┘
       │
       ↓
Step 4: 队列处理
┌──────────────┐
│ Bull Worker  │  从队列取出任务 → 开始处理
└──────┬───────┘
       │
       ↓
Step 5: 生成音频
┌──────────────┐
│ IndexTTS2    │  文本 → 音频 (带情感向量)
│   (GPU)      │  
└──────┬───────┘
       │
       ↓
Step 6: 生成视频
┌──────────────┐
│   ComfyUI    │  音频 + 模板 → 视频
│  MuseTalk    │  
│   (GPU)      │  
└──────┬───────┘
       │
       ↓
Step 7: 合并视频 (如果分段)
┌──────────────┐
│   FFmpeg     │  多个片段 → 合并成完整视频
└──────┬───────┘
       │
       ↓
Step 8: 完成
┌──────────────┐
│   通知用户   │  更新数据库 → 返回视频URL
└──────────────┘
```

---

## 🎤 IndexTTS2 工作流程

```
文本输入
   │
   ↓
┌─────────────────┐
│ 文本预处理      │  分词、添加标点、情感分析
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ 情感向量映射    │  [快乐, 愤怒, 悲伤, ...]
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ TTS模型推理     │  GPU加速生成
│  (IndexTTS2)    │  
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│ 后处理          │  音量归一化、降噪
└────────┬────────┘
         │
         ↓
    音频输出
   (WAV格式)
```

---

## 🎨 ComfyUI 视频生成流程

```
输入：音频 + 模板
      │
      ↓
┌──────────────────┐
│ 加载ComfyUI工作流│  读取JSON配置
└─────────┬────────┘
          │
          ↓
┌──────────────────┐
│ 音频特征提取     │  提取音频波形、频谱
└─────────┬────────┘
          │
          ↓
┌──────────────────┐
│ MuseTalk模型     │  音频驱动面部动画
│  (GPU推理)       │  
└─────────┬────────┘
          │
          ↓
┌──────────────────┐
│ 渲染视频帧       │  逐帧生成
└─────────┬────────┘
          │
          ↓
┌──────────────────┐
│ 编码输出         │  合成最终视频
└─────────┬────────┘
          │
          ↓
    视频输出
   (MP4格式)
```

---

## 📦 文件存储结构

```
/workspace/
│
├── videoai-pro/              # 主应用
│   ├── server/               # 后端代码
│   │   ├── index.js
│   │   ├── workers/          # 后台任务
│   │   ├── queues/           # 队列管理
│   │   └── services/         # 业务逻辑
│   │
│   ├── client/               # 前端代码
│   │   └── dist/             # 构建产物
│   │
│   ├── data/                 # 数据文件
│   │   └── database.sqlite   # SQLite数据库
│   │
│   ├── public/               # 静态文件
│   │   ├── uploads/          # 用户上传
│   │   ├── generated/        # 生成的视频
│   │   └── voices/           # 自定义声音
│   │
│   └── .env                  # 环境配置
│
├── IndexTTS2/                # TTS服务
│   ├── checkpoints/          # 模型文件
│   ├── api_server.py         # API服务器
│   └── venv/                 # Python环境
│
└── ComfyUI/                  # 视频生成服务
    ├── models/               # 模型文件
    ├── custom_nodes/
    │   └── MuseTalk/         # 数字人模型
    └── venv/                 # Python环境
```

---

## 🔄 数据库表关系

```
┌─────────────┐
│   users     │
│─────────────│
│ id          │──┐
│ username    │  │
│ email       │  │
│ password    │  │
└─────────────┘  │
                 │
                 │  1:N
                 ↓
        ┌─────────────┐
        │   tasks     │
        │─────────────│
        │ id          │
        │ user_id     │──┐
        │ status      │  │
        │ progress    │  │
        │ video_url   │  │
        │ ...         │  │
        └─────────────┘  │
                         │
                         │  1:1
                         ↓
                ┌─────────────────┐
                │ segment_data    │
                │─────────────────│
                │ (JSON字段)      │
                │ - segments[]    │
                │ - strategy      │
                │ - total_cost    │
                └─────────────────┘
```

---

## 🚀 部署脚本执行流程

### deploy_runpod.sh

```
开始执行
   │
   ↓
检查环境
   ├─ 检测工作目录 (/workspace)
   ├─ 显示系统信息
   └─ 询问确认
   │
   ↓
安装基础工具
   ├─ apt update & upgrade
   ├─ 安装 git, curl, vim
   └─ 安装 build-essential
   │
   ↓
安装Node.js 20
   ├─ 添加NodeSource仓库
   └─ apt install nodejs
   │
   ↓
安装Redis
   ├─ apt install redis-server
   └─ 启动Redis服务
   │
   ↓
安装FFmpeg
   └─ apt install ffmpeg
   │
   ↓
安装PM2
   └─ npm install -g pm2
   │
   ↓
克隆项目代码
   ├─ 询问Git仓库地址
   └─ git clone
   │
   ↓
部署后端
   ├─ npm install
   ├─ 创建.env配置
   ├─ 运行数据库迁移
   ├─ 构建前端
   └─ 启动PM2服务
   │
   ↓
配置Nginx
   ├─ 创建配置文件
   ├─ 启用站点
   └─ 重启Nginx
   │
   ↓
完成
   ├─ 显示访问地址
   └─ 显示常用命令
```

### deploy_ai_services.sh

```
开始执行
   │
   ↓
部署IndexTTS2
   ├─ 克隆仓库
   ├─ 创建虚拟环境
   ├─ 安装依赖
   ├─ 安装PyTorch (CUDA)
   ├─ 下载模型
   ├─ 创建API服务器
   └─ 启动PM2服务
   │
   ↓
部署ComfyUI
   ├─ 克隆仓库
   ├─ 创建虚拟环境
   ├─ 安装依赖
   ├─ 克隆MuseTalk
   ├─ 下载模型
   └─ 启动PM2服务
   │
   ↓
完成
   ├─ 显示服务状态
   └─ 显示测试命令
```

---

## 📊 性能监控流程

```
┌──────────────┐
│   用户访问   │
└──────┬───────┘
       │
       ↓
┌──────────────┐
│    Nginx     │  请求日志 → /var/log/nginx/access.log
│  (访问日志)  │  
└──────┬───────┘
       │
       ↓
┌──────────────┐
│  Express.js  │  应用日志 → PM2 logs
│  (应用日志)  │  
└──────┬───────┘
       │
       ↓
┌──────────────┐
│ Bull Queue   │  任务日志 → Redis + PM2 logs
│  (队列日志)  │  
└──────┬───────┘
       │
       ↓
┌──────────────┐
│  GPU Services│  GPU使用率 → nvidia-smi
│  (GPU监控)  │  
└──────────────┘
```

---

## 🎯 故障排查决策树

```
服务不可用
   │
   ├─ 无法访问网站？
   │  ├─ 检查Nginx → systemctl status nginx
   │  ├─ 检查端口 → netstat -tlnp
   │  └─ 检查防火墙 → ufw status
   │
   ├─ API报错？
   │  ├─ 查看后端日志 → pm2 logs videoai
   │  ├─ 检查Redis → redis-cli ping
   │  └─ 检查数据库 → sqlite3 data/database.sqlite
   │
   ├─ TTS失败？
   │  ├─ 查看TTS日志 → pm2 logs indextts2
   │  ├─ 检查模型文件 → ls checkpoints/
   │  └─ 测试API → curl localhost:9880/health
   │
   └─ 视频生成失败？
      ├─ 查看ComfyUI日志 → pm2 logs comfyui
      ├─ 检查GPU → nvidia-smi
      └─ 检查模型文件 → ls models/
```

---

## 🎉 部署成功标志

```
✅ 所有检查通过

┌─────────────────────────────────┐
│  pm2 status                     │
│  ┌─────┬────────┬─────────┐    │
│  │ id  │ name   │ status  │    │
│  ├─────┼────────┼─────────┤    │
│  │ 0   │ videoai│ online  │ ✅ │
│  │ 1   │indextts│ online  │ ✅ │
│  │ 2   │comfyui │ online  │ ✅ │
│  └─────┴────────┴─────────┘    │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  systemctl status nginx         │
│  ● nginx.service               │
│    Active: active (running) ✅  │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  redis-cli ping                 │
│  PONG ✅                        │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  nvidia-smi                     │
│  RTX 3090 24GB ✅               │
│  Memory Used: 2048 MiB          │
└─────────────────────────────────┘

🎉 系统运行正常！可以开始创建视频了！
```

---

**收藏此流程图，随时查阅部署流程！** 📌
